import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, updateDoc, 
  onSnapshot, query, addDoc, deleteDoc, orderBy 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged 
} from 'firebase/auth';
import { 
  Calendar, Heart, Star, Send, Trash2, Plus, Edit2,
  CheckCircle2, Flame, Award, Settings, BookOpen,
  Coffee, Globe, Activity, MessageSquare, ChevronLeft, ChevronRight, Save, X, Sparkles, Upload, Image as ImageIcon
} from 'lucide-react';

// --- Firebase 配置 ---
// 請在這裡填入你的 Firebase 專案金鑰
const firebaseConfig = {
  apiKey: "AIzaSyDLeH52pL_lGEhj41ejj59nEL5ge4MxsGk",
  authDomain: "kangs-2026.firebaseapp.com",
  projectId: "kangs-2026",
  storageBucket: "kangs-2026.firebasestorage.app",
  messagingSenderId: "1002873615830",
  appId: "1:1002873615830:web:54825d42280a09c367e077"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// 這裡定義你的應用程式 ID，可用於區分資料庫路徑
const APP_ID = 'kang2026';

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('daily');
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [tasks, setTasks] = useState([]);
  const [gratitude, setGratitude] = useState([]);
  const [letters, setLetters] = useState([]);
  const [visions, setVisions] = useState([]);
  const [moodLogs, setMoodLogs] = useState({});
  const [loading, setLoading] = useState(true);

  // --- 身份驗證 ---
  useEffect(() => {
    // 改為標準的匿名登入
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Firebase 驗證錯誤:", error);
      }
    };

    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (!u) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // --- 資料同步 ---
  useEffect(() => {
    if (!user) return;

    const baseRef = `artifacts/${APP_ID}/users/${user.uid}`;
    
    // 監聽任務
    const unsubTasks = onSnapshot(collection(db, `${baseRef}/tasks`), (snapshot) => {
      const taskList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setTasks(taskList);
      
      if (taskList.length === 0 && !snapshot.metadata.fromCache) {
        const defaults = [
          { title: "副業進度開發", category: "副業事業", frequency: "每日", isRecurring: true, targetCount: 100 },
          { title: "外語聽力修煉", category: "語言學習", frequency: "每日", isRecurring: true, targetCount: 100 },
          { title: "核心體能訓練", category: "健康體魄", frequency: "每日", isRecurring: true, targetCount: 100 }
        ];
        defaults.forEach(d => {
          addDoc(collection(db, `${baseRef}/tasks`), {
            ...d,
            completedDates: [],
            createdAt: new Date().toISOString()
          });
        });
      }
      setLoading(false);
    });

    const unsubVisions = onSnapshot(collection(db, `${baseRef}/visions`), (snapshot) => {
      setVisions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });

    const unsubGratitude = onSnapshot(collection(db, `${baseRef}/gratitude`), (snapshot) => {
      setGratitude(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });

    const unsubLetters = onSnapshot(query(collection(db, `${baseRef}/letters`), orderBy('createdAt', 'desc')), (snapshot) => {
      setLetters(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });

    const unsubMood = onSnapshot(collection(db, `${baseRef}/moods`), (snapshot) => {
      const moods = {};
      snapshot.docs.forEach(doc => { moods[doc.id] = doc.data(); });
      setMoodLogs(moods);
    });

    return () => {
      unsubTasks();
      unsubVisions();
      unsubGratitude();
      unsubLetters();
      unsubMood();
    };
  }, [user]);

  // --- 操作邏輯 (略，與原程式碼相同但確保路徑引用正確) ---
  const handleAddTask = async (taskData) => {
    if (!user) return;
    await addDoc(collection(db, `artifacts/${APP_ID}/users/${user.uid}/tasks`), {
      ...taskData,
      completedDates: [],
      createdAt: new Date().toISOString()
    });
  };

  const toggleTask = async (task) => {
    if (!user) return;
    const completedDates = task.completedDates || [];
    const isCompleted = completedDates.includes(selectedDate);
    const newDates = isCompleted 
      ? completedDates.filter(d => d !== selectedDate)
      : [...completedDates, selectedDate];
    
    await updateDoc(doc(db, `artifacts/${APP_ID}/users/${user.uid}/tasks`, task.id), {
      completedDates: newDates
    });
  };

  const saveVision = async (data) => {
    if (!user) return;
    await setDoc(doc(db, `artifacts/${APP_ID}/users/${user.uid}/visions`, 'primary'), {
      ...data,
      updatedAt: new Date().toISOString()
    });
  };

  const deleteTask = async (taskId) => {
    if (!user) return;
    await deleteDoc(doc(db, `artifacts/${APP_ID}/users/${user.uid}/tasks`, taskId));
  };

  const addGratitude = async (text) => {
    if (!user) return;
    await addDoc(collection(db, `artifacts/${APP_ID}/users/${user.uid}/gratitude`), {
      text,
      date: selectedDate,
      createdAt: new Date().toISOString()
    });
  };

  const saveLetter = async (content, id = null) => {
    if (!user) return;
    const ref = collection(db, `artifacts/${APP_ID}/users/${user.uid}/letters`);
    if (id) {
      await updateDoc(doc(db, `artifacts/${APP_ID}/users/${user.uid}/letters`, id), { content });
    } else {
      await addDoc(ref, {
        content,
        createdAt: new Date().toISOString(),
        unlockDate: '2026-12-31'
      });
    }
  };

  const deleteLetter = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, `artifacts/${APP_ID}/users/${user.uid}/letters`, id));
  };

  const updateMood = async (mood) => {
    if (!user) return;
    await setDoc(doc(db, `artifacts/${APP_ID}/users/${user.uid}/moods`, selectedDate), {
      mood,
      updatedAt: new Date().toISOString()
    });
  };

  if (loading) return (
    <div className="flex items-center justify-center h-screen bg-[#f7f2ed] text-[#14233a]">
      <div className="animate-bounce font-black tracking-tighter text-lg text-center px-6">
        正在建構您的實相空間...
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#f7f2ed] text-[#2d2d2d] font-sans pb-32">
      <header className="sticky top-0 z-50 bg-[#f7f2ed]/70 backdrop-blur-xl border-b-[0.5px] border-[#c0b8b4] p-6 flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-black text-[#14233a] tracking-tight">KANG'S 2026</h1>
          <p className="text-[10px] text-[#cb914a] font-bold tracking-[0.2em] uppercase">顯化紀錄系統</p>
        </div>
        <div className="w-10 h-10 rounded-full bg-[#14233a] flex items-center justify-center text-white shadow-inner">
          <Heart size={20} fill="currentColor" />
        </div>
      </header>

      <main className="max-w-xl mx-auto p-6 md:p-8">
        {activeTab === 'daily' && (
          <DailyView 
            selectedDate={selectedDate} 
            setSelectedDate={setSelectedDate}
            tasks={tasks}
            toggleTask={toggleTask}
            moodLogs={moodLogs}
            updateMood={updateMood}
            vision={visions.find(v => v.id === 'primary')}
          />
        )}
        {activeTab === 'matrix' && <MatrixView tasks={tasks} vision={visions.find(v => v.id === 'primary')} />}
        {activeTab === 'tasks' && <TaskManagement tasks={tasks} addTask={handleAddTask} deleteTask={deleteTask} saveVision={saveVision} vision={visions.find(v => v.id === 'primary')} />}
        {activeTab === 'gratitude' && <GratitudeBox gratitude={gratitude} addGratitude={addGratitude} />}
        {activeTab === 'future' && <FutureDialogue letters={letters} onSave={saveLetter} onDelete={deleteLetter} />}
      </main>

      <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-md bg-[#14233a] rounded-[3rem] p-2 shadow-2xl flex justify-between items-center z-[100]">
        <NavBtn active={activeTab === 'daily'} onClick={() => setActiveTab('daily')} icon={Calendar} label="今日" />
        <NavBtn active={activeTab === 'matrix'} onClick={() => setActiveTab('matrix')} icon={Award} label="進度" />
        <NavBtn active={activeTab === 'tasks'} onClick={() => setActiveTab('tasks')} icon={Settings} label="目標" />
        <NavBtn active={activeTab === 'gratitude'} onClick={() => setActiveTab('gratitude')} icon={Star} label="感恩" />
        <NavBtn active={activeTab === 'future'} onClick={() => setActiveTab('future')} icon={MessageSquare} label="留言" />
      </nav>
    </div>
  );
}

// ... 剩下的子組件 (DailyView, NavBtn, MatrixView, TaskManagement, GratitudeBox, FutureDialogue, CategoryIcon) 保持不變 ...
// (因篇幅限制，其餘 UI 組件代碼與您原始提供的一致，直接貼上即可)