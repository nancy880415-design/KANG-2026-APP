<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANG'S 2026 ç”Ÿå‘½å»ºç¯‰å¸«</title>
    
    <!-- æ ¸å¿ƒç’°å¢ƒè¼‰å…¥ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (Compat ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f7f2ed;
            margin: 0;
            overflow-x: hidden;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        .fade-entry {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. Firebase é…ç½® (å¡«å…¥é‡‘é‘°) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDLeH52pL_lGEhj41ejj59nEL5ge4MxsGk",
            authDomain: "kangs-2026.firebaseapp.com",
            projectId: "kangs-2026",
            storageBucket: "kangs-2026.firebasestorage.app",
            messagingSenderId: "1002873615830",
            appId: "1:1002873615830:web:54825d42280a09c367e077"
        };

        // åˆå§‹åŒ–
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "kang2026";

        // --- 2. ç©©å®šç‰ˆ SVG åœ–æ¨™ ---
        const Icons = {
            Calendar: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Heart: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill={p.fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Star: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill={p.fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Award: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>,
            Settings: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Message: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Plus: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
            Trash: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Check: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="20 6 9 17 4 12"/></svg>,
            ChevronLeft: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="9 18 15 12 9 6"/></svg>,
            Send: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Edit: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Save: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Upload: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Image: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Sparkles: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z"/></svg>,
            Coffee: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            Globe: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Activity: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            BookOpen: (p) => <svg width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        };

        // --- 3. æ ¸å¿ƒé‚è¼¯ ---
        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('daily');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [tasks, setTasks] = useState([]);
            const [gratitude, setGratitude] = useState([]);
            const [letters, setLetters] = useState([]);
            const [visions, setVisions] = useState([]);
            const [moodLogs, setMoodLogs] = useState({});
            const [loading, setLoading] = useState(true);

            const categories = ['å‰¯æ¥­äº‹æ¥­', 'èªè¨€å­¸ç¿’', 'å¥åº·é«”é­„', 'å¿ƒéˆæˆé•·', 'ä¼‘é–’æ¨‚è¶£'];

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) { setUser(u); } 
                    else { auth.signInAnonymously().catch(e => console.error("é©—è­‰éŒ¯èª¤:", e)); }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const userRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                
                // ä»»å‹™ç›£è½ + è‡ªå‹•åˆå§‹åŒ–æ ¸å¿ƒç›®æ¨™ (ä¿®å¾©)
                const unsubTasks = userRef.collection('tasks').onSnapshot(snap => {
                    const taskList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTasks(taskList);
                    
                    if (taskList.length === 0 && !snap.metadata.fromCache) {
                        const defaults = [
                            { title: "å‰¯æ¥­é€²åº¦é–‹ç™¼", category: "å‰¯æ¥­äº‹æ¥­", frequency: "æ¯æ—¥", type: "å¤§é …ç›®", targetCount: 100, createdAt: new Date().toISOString(), completedDates: [] },
                            { title: "å¤–èªè½åŠ›ä¿®ç…‰", category: "èªè¨€å­¸ç¿’", frequency: "æ¯æ—¥", type: "å¤§é …ç›®", targetCount: 100, createdAt: new Date().toISOString(), completedDates: [] },
                            { title: "æ ¸å¿ƒé«”èƒ½è¨“ç·´", category: "å¥åº·é«”é­„", frequency: "æ¯æ—¥", type: "å¤§é …ç›®", targetCount: 100, createdAt: new Date().toISOString(), completedDates: [] }
                        ];
                        defaults.forEach(d => userRef.collection('tasks').add(d));
                    }
                    setLoading(false);
                });

                const unsubVisions = userRef.collection('visions').onSnapshot(snap => setVisions(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubGratitude = userRef.collection('gratitude').orderBy('createdAt', 'desc').onSnapshot(snap => setGratitude(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubLetters = userRef.collection('letters').orderBy('createdAt', 'desc').onSnapshot(snap => setLetters(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubMood = userRef.collection('moods').onSnapshot(snap => {
                    const moods = {};
                    snap.docs.forEach(d => moods[d.id] = d.data());
                    setMoodLogs(moods);
                });

                return () => { unsubTasks(); unsubVisions(); unsubGratitude(); unsubLetters(); unsubMood(); };
            }, [user]);

            const handleTaskToggle = async (task) => {
                if (!user) return;
                const dates = task.completedDates || [];
                const isDone = dates.includes(selectedDate);
                const newDates = isDone ? dates.filter(d => d !== selectedDate) : [...dates, selectedDate];
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').doc(task.id).update({ completedDates: newDates });
            };

            const saveVision = async (data) => {
                if (!user) return;
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('visions').doc('primary').set({ ...data, updatedAt: new Date().toISOString() });
            };

            const addGratitude = async (text) => {
                if (!user) return;
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('gratitude').add({ text, date: selectedDate, createdAt: new Date().toISOString() });
            };

            const NavBtn = ({ id, icon: IconComp, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center gap-1 transition-all duration-300 flex-1 py-3 rounded-[2.5rem] ${activeTab === id ? 'bg-[#cb914a] text-white scale-105 shadow-lg' : 'text-[#86a0bb] hover:text-white'}`}>
                    <IconComp size={18} />
                    <span className="text-[10px] font-black">{label}</span>
                </button>
            );

            if (loading && !user) return (
                <div className="flex items-center justify-center h-screen bg-[#f7f2ed] text-[#14233a]">
                    <div className="animate-pulse font-black text-lg text-center px-6 text-[#cb914a]">æ­£åœ¨åŒæ­¥æ‚¨çš„ 2026 é »ç‡...</div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#f7f2ed] text-[#2d2d2d] font-sans pb-32">
                    <header className="sticky top-0 z-50 bg-[#f7f2ed]/70 backdrop-blur-xl border-b-[0.5px] border-[#c0b8b4] p-6 flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-black text-[#14233a] tracking-tight">KANG'S 2026</h1>
                            <p className="text-[10px] text-[#cb914a] font-bold tracking-[0.2em] uppercase">ç”Ÿå‘½å»ºç¯‰å¸«ç³»çµ±</p>
                        </div>
                        <div className="w-10 h-10 rounded-full bg-[#14233a] flex items-center justify-center text-white shadow-inner">
                            <Icons.Heart size={20} fill="currentColor" />
                        </div>
                    </header>

                    <main className="max-w-xl mx-auto p-6">
                        {activeTab === 'daily' && <DailyView selectedDate={selectedDate} setSelectedDate={setSelectedDate} tasks={tasks} onToggle={handleTaskToggle} moodLogs={moodLogs} vision={visions.find(v => v.id === 'primary')} user={user} db={db} appId={appId}/>}
                        {activeTab === 'matrix' && <MatrixView tasks={tasks} visions={visions} categories={categories} />}
                        {activeTab === 'tasks' && <TaskManagement tasks={tasks} saveVision={saveVision} vision={visions.find(v => v.id === 'primary')} user={user} db={db} appId={appId} categories={categories} />}
                        {activeTab === 'gratitude' && <GratitudeBox gratitude={gratitude} addGratitude={addGratitude} user={user} db={db} appId={appId} />}
                        {activeTab === 'future' && <FutureDialogue letters={letters} onSave={(c, id) => {
                            const ref = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('letters');
                            if(id) ref.doc(id).update({ content: c });
                            else ref.add({ content: c, createdAt: new Date().toISOString() });
                        }} onDelete={(id) => db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('letters').doc(id).delete()} />}
                    </main>

                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-md bg-[#14233a] rounded-[3rem] p-2 shadow-2xl flex justify-between items-center z-[100]">
                        <NavBtn id="daily" icon={Icons.Calendar} label="ä»Šæ—¥" />
                        <NavBtn id="matrix" icon={Icons.Award} label="é€²åº¦" />
                        <NavBtn id="tasks" icon={Icons.Settings} label="ç›®æ¨™" />
                        <NavBtn id="gratitude" icon={Icons.Star} label="æ„Ÿæ©" />
                        <NavBtn id="future" icon={Icons.Message} label="ç•™è¨€" />
                    </nav>
                </div>
            );
        }

        // --- å­çµ„ä»¶ ---

        function DailyView({ selectedDate, setSelectedDate, tasks, onToggle, moodLogs, vision, user, db, appId }) {
            const dayTasks = tasks.filter(t => t.frequency === 'æ¯æ—¥' || t.createdAt?.startsWith(selectedDate));
            const currentMood = moodLogs[selectedDate]?.mood || null;

            return (
                <div className="space-y-6 fade-entry">
                    {vision?.base64 && (
                        <div className="relative w-full aspect-[16/9] rounded-[2.5rem] overflow-hidden shadow-xl border-[0.5px] border-[#c0b8b4]">
                            <img src={vision.base64} className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
                            <div className="absolute bottom-6 left-8 text-white">
                                <p className="text-[10px] font-bold uppercase tracking-widest opacity-70">æ­£åœ¨é¡¯åŒ–</p>
                                <p className="text-lg font-black leading-tight">{vision.title}</p>
                            </div>
                        </div>
                    )}
                    <div className="bg-white p-5 rounded-[2.5rem] border-[0.5px] border-[#c0b8b4] shadow-sm flex items-center justify-between">
                        <button onClick={() => { let d = new Date(selectedDate); d.setDate(d.getDate()-1); setSelectedDate(d.toISOString().split('T')[0]); }} className="p-2"><Icons.ChevronLeft size={24}/></button>
                        <div className="text-center">
                            <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="font-black text-lg border-none bg-transparent text-center focus:ring-0" />
                            <p className="text-[10px] text-[#cb914a] uppercase font-black">ä»Šæ—¥ä¿®ç…‰é€²åº¦</p>
                        </div>
                        <button onClick={() => { let d = new Date(selectedDate); d.setDate(d.getDate()+1); setSelectedDate(d.toISOString().split('T')[0]); }} className="p-2"><Icons.ChevronRight size={24}/></button>
                    </div>
                    <div className="flex justify-around bg-white p-4 rounded-[2rem] border-[0.5px] border-[#c0b8b4] shadow-sm">
                        {['ğŸŒ¤ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'âš¡', 'ğŸŒ™'].map(m => (
                            <button key={m} onClick={() => db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('moods').doc(selectedDate).set({ mood: m, updatedAt: new Date().toISOString() })} className={`text-3xl transition-all duration-300 hover:scale-125 ${currentMood === m ? 'opacity-100 scale-125' : 'opacity-20 grayscale'}`}>{m}</button>
                        ))}
                    </div>
                    <div className="space-y-4">
                        {dayTasks.map(task => {
                            const isDone = task.completedDates?.includes(selectedDate);
                            const progress = Math.min(((task.completedDates?.length || 0) / (parseInt(task.targetCount) || 100)) * 100, 100);
                            return (
                                <div key={task.id} onClick={() => onToggle(task)} className={`group flex flex-col p-5 rounded-[2.5rem] border-[0.5px] cursor-pointer transition-all ${isDone ? 'bg-[#5b8e7d] border-transparent text-white shadow-lg translate-y-1' : 'bg-white border-[#c0b8b4] hover:shadow-md'}`}>
                                    <div className="flex items-center justify-between w-full mb-3">
                                        <div className="flex items-center gap-4">
                                            <CategoryIcon category={task.category} active={isDone} />
                                            <div>
                                                <h4 className="font-bold text-sm tracking-tight">{task.title}</h4>
                                                <p className={`text-[9px] font-bold tracking-widest ${isDone ? 'opacity-60' : 'text-[#86a0bb]'}`}>{task.type || 'å°é …ç›®'} â€¢ {task.category}</p>
                                            </div>
                                        </div>
                                        <Icons.Check size={20} className={isDone ? 'text-white' : 'text-[#c0b8b4]'} />
                                    </div>
                                    <div className={`w-full h-1 rounded-full overflow-hidden ${isDone ? 'bg-white/20' : 'bg-[#f7f2ed]'}`}>
                                        <div className={`h-full transition-all duration-1000 ${isDone ? 'bg-white' : 'bg-[#cb914a]'}`} style={{ width: `${progress}%` }} />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function MatrixView({ tasks, visions, categories }) {
            const vision = visions.find(v => v.id === 'primary');
            const days = useMemo(() => {
                const arr = [];
                const now = new Date();
                for (let i = 0; i < 84; i++) {
                    const d = new Date(); d.setDate(now.getDate() - i);
                    arr.unshift(d.toISOString().split('T')[0]);
                }
                return arr;
            }, []);

            const categoryProgress = useMemo(() => {
                return categories.map(cat => {
                    const catTasks = tasks.filter(t => t.category === cat);
                    if (catTasks.length === 0) return { name: cat, percent: 0 };
                    const totalDone = catTasks.reduce((acc, t) => acc + (t.completedDates?.length || 0), 0);
                    const totalTarget = catTasks.reduce((acc, t) => acc + (parseInt(t.targetCount) || 100), 0);
                    return { name: cat, percent: Math.min((totalDone / totalTarget) * 100, 100) };
                });
            }, [tasks, categories]);

            const overallProgress = useMemo(() => {
                if (tasks.length === 0) return 0;
                const totalDone = tasks.reduce((acc, t) => acc + (t.completedDates?.length || 0), 0);
                const totalTarget = tasks.reduce((acc, t) => acc + (parseInt(t.targetCount) || 100), 0);
                return Math.min((totalDone / totalTarget) * 100, 100);
            }, [tasks]);

            const getHeatLevel = (date) => {
                const doneCount = tasks.filter(t => t.completedDates?.includes(date)).length;
                if (doneCount === 0) return 'bg-[#f7f2ed]';
                if (doneCount === 1) return 'bg-[#86a0bb] opacity-40';
                if (doneCount === 2) return 'bg-[#86a0bb] opacity-70';
                return 'bg-[#cb914a]';
            };

            return (
                <div className="space-y-8 fade-entry pb-10">
                    <section className="bg-[#14233a] p-8 rounded-[3.5rem] text-white shadow-2xl relative overflow-hidden text-center">
                        <div className="absolute top-0 right-0 p-8 opacity-10"><Icons.Sparkles size={120} /></div>
                        <p className="text-[10px] text-[#cb914a] font-black uppercase tracking-widest mb-2">å¹´åº¦ç¸½é¡¯åŒ–ç‡</p>
                        <h3 className="text-5xl font-black mb-6 tracking-tighter">{overallProgress.toFixed(1)}%</h3>
                        <div className="relative w-full aspect-[3/4] rounded-[2.5rem] overflow-hidden bg-white/5 border border-white/10 mb-6">
                           {vision?.base64 ? <img src={vision.base64} className="w-full h-full object-cover transition-all duration-1000" style={{ filter: `grayscale(${100 - overallProgress}%)` }} /> : <div className="flex items-center justify-center h-full opacity-20"><Icons.Image size={48} /></div>}
                        </div>
                        <div className="w-full h-2 bg-white/10 rounded-full overflow-hidden shadow-inner">
                           <div className="h-full bg-[#cb914a] transition-all duration-1000 shadow-[0_0_15px_rgba(203,145,74,0.4)]" style={{ width: `${overallProgress}%` }} />
                        </div>
                    </section>

                    <div className="bg-white p-6 rounded-[2.5rem] border-[0.5px] border-[#c0b8b4] shadow-sm">
                        <h4 className="text-[10px] font-black text-[#14233a] uppercase mb-4 px-1">ç”Ÿå‘½é ˜åŸŸé¡¯åŒ–åº¦</h4>
                        <div className="space-y-4 px-1">
                            {categoryProgress.map(cp => (
                                <div key={cp.name} className="space-y-1.5">
                                    <div className="flex justify-between items-center text-[10px] font-bold">
                                        <span className="uppercase tracking-widest">{cp.name}</span>
                                        <span className="text-[#cb914a] font-black">{cp.percent.toFixed(0)}%</span>
                                    </div>
                                    <div className="w-full h-1 bg-[#f7f2ed] rounded-full overflow-hidden">
                                        <div className="h-full bg-[#86a0bb] transition-all duration-1000" style={{ width: `${cp.percent}%` }} />
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-[2.5rem] border-[0.5px] border-[#c0b8b4] shadow-sm text-center">
                        <h4 className="text-[10px] font-black text-[#14233a] uppercase mb-4 px-1 tracking-widest">èƒ½é‡æµå‹•çŸ©é™£</h4>
                        <div className="matrix-grid px-1">
                           {days.map(d => (
                             <div key={d} title={d} className={`w-full aspect-square rounded-[4px] transition-all ${getHeatLevel(d)} border-[0.5px] border-[#c0b8b4]/10`} />
                           ))}
                        </div>
                    </div>
                </div>
            );
        }

        function TaskManagement({ tasks, saveVision, vision, user, db, appId, categories }) {
            const [newTitle, setNewTitle] = useState('');
            const [newCat, setNewCat] = useState('å‰¯æ¥­äº‹æ¥­');
            const [newType, setNewType] = useState('å°é …ç›®');
            const [newFreq, setNewFreq] = useState('æ¯æ—¥');
            const [newTarget, setNewTarget] = useState(100);
            const fileInputRef = useRef();

            const add = async () => {
                if(!newTitle) return;
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').add({
                    title: newTitle, category: newCat, type: newType, frequency: newFreq, targetCount: parseInt(newTarget),
                    completedDates: [], createdAt: new Date().toISOString(), isRecurring: true
                });
                setNewTitle('');
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => saveVision({ base64: reader.result, title: vision?.title || 'æˆ‘çš„ 2026 ç”Ÿæ´»' });
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="space-y-8 fade-entry pb-10">
                    <section className="bg-white p-8 rounded-[3rem] border-[0.5px] border-[#cb914a] space-y-6 shadow-sm">
                        <h3 className="font-black text-xl flex items-center gap-3 text-[#14233a]"><Icons.Image className="text-[#cb914a]"/>å¯¦ç›¸é¡˜æ™¯è¨­å®š</h3>
                        <input value={vision?.title || ''} onChange={e => saveVision({...vision, title: e.target.value})} className="w-full p-4 rounded-2xl bg-[#f7f2ed] border-none font-bold text-sm shadow-inner" placeholder="é¡˜æ™¯åç¨±..." />
                        <button onClick={() => fileInputRef.current.click()} className="w-full bg-[#14233a] text-white p-4 rounded-[1.5rem] font-black flex items-center justify-center gap-2 active:scale-95 transition-all"><Icons.Upload size={18}/> æœ¬åœ°ä¸Šå‚³é¡˜æ™¯åœ– (ç›´å¼åœ–)</button>
                        <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    </section>
                    
                    <section className="bg-white p-8 rounded-[3rem] border-[0.5px] border-[#c0b8b4] space-y-4 shadow-sm">
                        <h3 className="font-black text-lg text-[#14233a]">æ–°å¢ç”Ÿå‘½ç›®æ¨™</h3>
                        <input value={newTitle} onChange={e => setNewTitle(e.target.value)} className="w-full p-4 rounded-2xl bg-[#f7f2ed] border-none font-bold text-sm shadow-inner" placeholder="ç›®æ¨™åç¨±..." />
                        <div className="grid grid-cols-2 gap-3">
                            <div className="space-y-1">
                                <p className="text-[9px] font-bold px-2 text-[#86a0bb] uppercase">é¡åˆ¥</p>
                                <select value={newCat} onChange={e => setNewCat(e.target.value)} className="w-full p-3 bg-[#f7f2ed] rounded-xl text-[10px] font-black border-none">
                                    {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div className="space-y-1">
                                <p className="text-[9px] font-bold px-2 text-[#86a0bb] uppercase">è¦æ¨¡</p>
                                <select value={newType} onChange={e => setNewType(e.target.value)} className="w-full p-3 bg-[#f7f2ed] rounded-xl text-[10px] font-black border-none">
                                    <option value="å¤§é …ç›®">å¤§é …ç›®</option>
                                    <option value="å°é …ç›®">å°é …ç›®</option>
                                </select>
                            </div>
                            <div className="space-y-1">
                                <p className="text-[9px] font-bold px-2 text-[#86a0bb] uppercase">é€±æœŸ</p>
                                <select value={newFreq} onChange={e => setNewFreq(e.target.value)} className="w-full p-3 bg-[#f7f2ed] rounded-xl text-[10px] font-black border-none">
                                    <option value="æ¯æ—¥">æ¯æ—¥</option>
                                    <option value="æ¯é€±">æ¯é€±</option>
                                    <option value="æ¯æœˆ">æ¯æœˆ</option>
                                </select>
                            </div>
                            <div className="space-y-1">
                                <p className="text-[9px] font-bold px-2 text-[#86a0bb] uppercase">é¡¯åŒ–é–€æª»</p>
                                <input type="number" value={newTarget} onChange={e => setNewTarget(e.target.value)} className="w-full p-3 rounded-xl bg-[#f7f2ed] border-none text-[10px] font-black" />
                            </div>
                        </div>
                        <button onClick={add} className="w-full bg-[#cb914a] text-white p-4 rounded-2xl font-black shadow-lg">å•Ÿå‹•è¨ˆç•«</button>
                    </section>

                    <div className="space-y-4 px-1">
                        {tasks.map(t => (
                            <div key={t.id} className="bg-white p-5 rounded-[2.5rem] border-[0.5px] border-[#c0b8b4] flex justify-between items-center shadow-sm">
                                <div className="flex items-center gap-4">
                                    <CategoryIcon category={t.category} />
                                    <div>
                                        <p className="font-bold text-sm">{t.title}</p>
                                        <p className="text-[9px] font-black text-[#86a0bb] uppercase tracking-widest">{t.type} â€¢ {t.frequency}</p>
                                    </div>
                                </div>
                                <button onClick={() => db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').doc(t.id).delete()} className="text-red-300 p-2 hover:text-red-400 transition-colors"><Icons.Trash size={16} /></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function GratitudeBox({ gratitude, addGratitude, user, db, appId }) {
            const [text, setText] = useState('');
            return (
                <div className="space-y-8 fade-entry pb-10 text-center">
                    <div className="relative h-72 bg-[#14233a] rounded-[4rem] border-8 border-white shadow-xl flex flex-col items-center justify-center overflow-hidden">
                        <div className="absolute top-6 px-4 py-1 bg-[#cb914a] rounded-full text-[9px] font-black text-white uppercase tracking-widest shadow-lg">æ„Ÿæ©å¾®å…‰ä¸­å¿ƒ</div>
                        <div className="flex flex-wrap gap-2 p-10 justify-center">
                            {gratitude.slice(0, 50).map((_, i) => <Icons.Star key={i} size={14} className="text-[#cb914a]" fill="#cb914a" />)}
                        </div>
                        <p className="text-[10px] text-white/40 font-black tracking-widest mb-4 uppercase">å·²æ”¶é›† {gratitude.length} é¡†å¾®å…‰</p>
                    </div>
                    <textarea value={text} onChange={e => setText(e.target.value)} placeholder="ä»Šæ—¥ç™¼ç”Ÿäº†ä»€éº¼å€¼å¾—æ„Ÿæ©çš„å°äº‹ï¼Ÿ" className="w-full p-6 rounded-[2rem] bg-[#f7f2ed] border-none shadow-inner min-h-[140px] text-sm font-bold resize-none" />
                    <button onClick={async () => { if(text) { await addGratitude(text); setText(''); } }} className="w-full bg-[#14233a] text-white p-5 rounded-[2.5rem] font-black shadow-lg active:scale-95 transition-all">æŠ•é€²å„²å­˜ç®±</button>

                    <div className="space-y-4 text-left px-2">
                        <h3 className="font-black text-lg text-[#14233a] mt-8 mb-4 px-2">å¾®å…‰å›é¡§</h3>
                        {gratitude.map(g => (
                            <div key={g.id} className="bg-white p-6 rounded-[2.5rem] border-[0.5px] border-[#c0b8b4] shadow-sm">
                                <p className="text-sm font-bold leading-relaxed">{g.text}</p>
                                <div className="flex justify-between items-center mt-4 pt-3 border-t-[0.5px] border-[#f7f2ed]">
                                    <span className="text-[9px] text-[#86a0bb] font-black uppercase">{new Date(g.createdAt).toLocaleDateString()}</span>
                                    <button onClick={() => db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('gratitude').doc(g.id).delete()} className="text-[#c0b8b4] hover:text-red-300 transition-colors"><Icons.Trash size={14}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function FutureDialogue({ letters, onSave, onDelete }) {
            const [text, setText] = useState('');
            const [editingId, setEditingId] = useState(null);
            return (
                <div className="space-y-8 fade-entry pb-10">
                    <div className="bg-white p-4 rounded-[3rem] border-[0.5px] border-[#c0b8b4] shadow-md flex items-center gap-3 pr-2 mx-1">
                        <textarea value={text} onChange={e => setText(e.target.value)} placeholder="çµ¦ 2026 å¹´åº•çš„æˆ‘..." className="flex-1 bg-transparent border-none text-sm font-bold p-4 h-14 resize-none focus:ring-0" />
                        <button onClick={() => { if(text) { onSave(text, editingId); setText(''); setEditingId(null); } }} className="bg-[#cb914a] text-white p-4 rounded-full shadow-lg active:scale-90 transition-all">{editingId ? <Icons.Save size={20}/> : <Icons.Send size={20}/>}</button>
                    </div>
                    <div className="space-y-6">
                        {letters.map((l, i) => (
                            <div key={l.id} className="relative bg-white p-8 rounded-[2.5rem] shadow-sm border-[0.5px] border-[#c0b8b4]">
                                <div className="absolute -top-3 left-8 px-4 py-1 bg-[#14233a] text-white text-[9px] font-black rounded-full shadow-md uppercase">ä¿¡ä»¶ #{letters.length - i}</div>
                                <p className="text-sm font-bold leading-relaxed">{l.content}</p>
                                <div className="flex justify-between items-center mt-6 pt-4 border-t-[0.5px] border-[#f7f2ed]">
                                    <span className="text-[10px] opacity-30 font-bold uppercase">{new Date(l.createdAt).toLocaleDateString()}</span>
                                    <div className="flex gap-4">
                                        <button onClick={() => { setText(l.content); setEditingId(l.id); window.scrollTo({top: 0, behavior: 'smooth'}); }} className="text-[#cb914a]"><Icons.Edit size={14}/></button>
                                        <button onClick={() => onDelete(l.id)} className="text-red-200"><Icons.Trash size={14}/></button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function CategoryIcon({ category, active }) {
            const icons = { 'å‰¯æ¥­äº‹æ¥­': Icons.Coffee, 'èªè¨€å­¸ç¿’': Icons.Globe, 'å¥åº·é«”é­„': Icons.Activity, 'å¿ƒéˆæˆé•·': Icons.Heart, 'ä¼‘é–’æ¨‚è¶£': Icons.Star };
            const Comp = icons[category] || Icons.BookOpen;
            const colorMap = { 'å‰¯æ¥­äº‹æ¥­': 'text-[#cb914a]', 'èªè¨€å­¸ç¿’': 'text-[#86a0bb]', 'å¥åº·é«”é­„': 'text-[#5b8e7d]', 'å¿ƒéˆæˆé•·': 'text-red-400', 'ä¼‘é–’æ¨‚è¶£': 'text-yellow-500' };
            return <div className={`p-3 rounded-2xl ${active ? 'bg-white/30' : 'bg-[#f7f2ed]'} transition-all`}><Comp size={18} className={active ? 'text-white' : colorMap[category]} strokeWidth={3}/></div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>