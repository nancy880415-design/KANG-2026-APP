import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, getDoc, 
  query, onSnapshot, orderBy, addDoc, serverTimestamp, deleteDoc, updateDoc, getDocs
} from 'firebase/firestore';
import { 
  getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged 
} from 'firebase/auth';
import { 
  CheckCircle2, BookOpen, History, Sparkles, 
  Heart, Trophy, Search, Send, Loader2, Plus, Trash2, Calendar as CalendarIcon, Settings2, 
  ChevronRight, MessageSquareQuote, Edit3, X, Star, PartyPopper, Repeat, Clock, Bookmark, BarChart3, TrendingUp, Cloud, Coffee, AlertTriangle, RefreshCw, Flame, ExternalLink, Leaf, StickyNote, Wind, Award
} from 'lucide-react';

// --- Firebase é…ç½® ---
const firebaseConfig = {
  apiKey: "AIzaSyDLeH52pL_lGEhj41ejj59nEL5ge4MxsGk",
  authDomain: "kangs-2026.firebaseapp.com",
  projectId: "kangs-2026",
  storageBucket: "kangs-2026.firebasestorage.app",
  messagingSenderId: "1002873615830",
  appId: "1:1002873615830:web:54825d42280a09c367e077"
};
const appId = 'kang2026'; // é€™è£¡å›ºå®šå¯«ä½ çš„å°ˆæ¡ˆåç¨±å°±å¥½

// --- æ—¥ç³»ç§‹å­£é…è‰²ç³»çµ± (Autumn Zen) ---
const theme = {
  bg: "#f7f2ed",
  card: "#ffffff",
  border: "#c0b8b4",
  secondary: "#86a0bb",
  primary: "#14233a",
  accent: "#cb914a",
  text: "#2d2d2d",
  success: "#5b8e7d",
  danger: "#a63d40"
};

const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½æ—¥ç³»æ¥µç°¡ä¸»ç¾©çš„ç”Ÿå‘½å»ºç¯‰å¸«ã€‚
ä½ çš„ä»»å‹™æ˜¯æä¾›æº«æš–å¦‚ç§‹é™½ã€ç´”æ–‡å­—ä¸”å……æ»¿å“²æ€çš„åé¥‹ã€‚
1. åš´ç¦ä½¿ç”¨ä»»ä½•æ¨™é»ç¬¦è™Ÿä¹‹å¤–çš„ç¬¦è™Ÿ (å¦‚ #, *, -)ã€‚
2. é‡å°é¿é¢¨æ¸¯é‡å•Ÿï¼šçµ¦äºˆæ¥µçŸ­ã€å……æ»¿åŠ›é‡çš„ä¸€å¥è©±ã€‚`;

async function callGemini(prompt, systemInstruction = SYSTEM_PROMPT) {
  const apiKey = ""; 
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      })
    });
    const data = await response.json();
    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
    return text.replace(/[#*]/g, '').trim();
  } catch (err) { return "ç§‹é¢¨æ éï¼Œå°å¸«æ­£åœ¨æ²ˆæ€ã€‚"; }
}

const Card = ({ children, className = "", style = {} }) => (
  <div style={{ borderColor: theme.border, ...style }} className={`bg-white rounded-[2.5rem] border-[0.5px] shadow-sm p-7 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = 'primary', loading = false, disabled = false, className = "" }) => {
  const styles = {
    primary: { backgroundColor: theme.primary, color: "#fff" },
    secondary: { backgroundColor: theme.secondary, color: "#fff" },
    accent: { backgroundColor: theme.accent, color: "#fff" },
    danger: { backgroundColor: theme.danger, color: "#fff" },
    ghost: { backgroundColor: "transparent", color: theme.secondary, border: `1px solid ${theme.border}` }
  };
  return (
    <button onClick={onClick} disabled={loading || disabled} style={styles[variant]} className={`px-6 py-3.5 rounded-2xl font-black transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${className}`}>
      {loading && <Loader2 className="w-4 h-4 animate-spin" />}
      {children}
    </button>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('today');
  const [loading, setLoading] = useState(true);
  const [logs, setLogs] = useState([]);
  const [journals, setJournals] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [templates, setTemplates] = useState([]);
  const [seeds, setSeeds] = useState([]);
  const [showCelebration, setShowCelebration] = useState(false);

  const getPath = useCallback((col) => {
    if (!user) return null;
    return `artifacts/${appId}/users/${user.uid}/${col}`;
  }, [user]);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else { await signInAnonymously(auth); }
    };
    initAuth();
    onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
  }, []);

  useEffect(() => {
    if (!user) return;
    const setupListener = (colName, setter) => {
      const path = getPath(colName);
      if (!path) return;
      return onSnapshot(query(collection(db, path)), (snap) => {
        setter(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      });
    };
    const unsubLogs = setupListener('dailyLogs', setLogs);
    const unsubJournals = setupListener('journalEntries', setJournals);
    const unsubFavs = setupListener('favoriteReviews', setFavorites);
    const unsubTemps = setupListener('taskTemplates', setTemplates);
    const unsubSeeds = setupListener('seeds', setSeeds);
    return () => { unsubLogs?.(); unsubJournals?.(); unsubFavs?.(); unsubTemps?.(); unsubSeeds?.(); };
  }, [user, getPath]);

  if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-[#f7f2ed]"><Leaf className="animate-bounce text-[#cb914a] mb-4" size={40}/><div className="font-black tracking-[0.3em] text-[#14233a]">KANG'S 2026</div></div>;

  return (
    <div className="min-h-screen pb-36 font-sans selection:bg-amber-200" style={{ backgroundColor: theme.bg, color: theme.text }}>
      {showCelebration && (
        <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/90 backdrop-blur-2xl animate-in fade-in zoom-in duration-700 cursor-pointer text-center px-10" onClick={() => setShowCelebration(false)}>
          <div className="relative mb-8">
             <PartyPopper size={120} style={{ color: theme.accent }} className="animate-bounce" />
             <div className="absolute inset-0 animate-ping rounded-full bg-orange-200/30"></div>
          </div>
          <h2 className="text-4xl font-black mb-4 tracking-tighter">æ„å¿—çš„ç”œç¾æœå¯¦</h2>
          <p className="text-slate-500 font-medium leading-relaxed italic">ä»Šå¤©ä¹Ÿæ˜¯é‚£ 20% çš„é—œéµä¸€å¤©ã€‚</p>
        </div>
      )}

      <header className="sticky top-0 z-40 bg-white/60 backdrop-blur-xl border-b px-6 py-6" style={{ borderColor: theme.border }}>
        <div className="max-w-2xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
             <div className="w-10 h-10 bg-[#14233a] rounded-2xl flex items-center justify-center shadow-lg"><Star size={20} fill="#cb914a" stroke="#cb914a" /></div>
             <h1 className="text-xl font-black tracking-tighter">KANG's 2026</h1>
          </div>
          <button onClick={() => setActiveTab('favs')} className={`p-2 rounded-xl transition-all ${activeTab === 'favs' ? 'bg-indigo-50 text-indigo-600 shadow-inner' : 'text-slate-400 hover:bg-slate-100'}`}>
            <Bookmark size={24} />
          </button>
        </div>
      </header>

      <main className="max-w-2xl mx-auto px-4 py-6">
        {activeTab === 'today' && <TodayView db={db} user={user} getPath={getPath} onCelebrate={() => setShowCelebration(true)} templates={templates} logs={logs} seeds={seeds} />}
        {activeTab === 'reflect' && <ReflectView db={db} user={user} getPath={getPath} journals={journals} logs={logs} />}
        {activeTab === 'ai' && <AIView logs={logs} journals={journals} templates={templates} db={db} getPath={getPath} seeds={seeds} />}
        {activeTab === 'favs' && <FavoritesView favorites={favorites} db={db} getPath={getPath} />}
      </main>

      <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-2xl border-t px-8 py-6 z-40" style={{ borderColor: theme.border }}>
        <div className="max-w-2xl mx-auto flex justify-between items-center">
          <NavButton active={activeTab === 'today'} icon={<CheckCircle2 />} label="åŠªåŠ›" onClick={() => setActiveTab('today')} />
          <NavButton active={activeTab === 'reflect'} icon={<MessageSquareQuote />} label="ç•™è¨€" onClick={() => setActiveTab('reflect')} />
          <NavButton active={activeTab === 'ai'} icon={<TrendingUp />} label="æˆé•·" onClick={() => setActiveTab('ai')} />
        </div>
      </nav>
    </div>
  );
}

function NavButton({ active, icon, label, onClick }) {
  return (
    <button onClick={onClick} className="flex flex-col items-center gap-1.5 transition-all" style={{ color: active ? theme.primary : theme.secondary, opacity: active ? 1 : 0.4 }}>
      {React.cloneElement(icon, { size: 26, strokeWidth: active ? 3 : 2 })}
      <span className="text-[10px] font-black tracking-widest uppercase">{label}</span>
    </button>
  );
}

// --- ä»Šæ—¥åŠªåŠ›é é¢ ---
function TodayView({ db, user, getPath, onCelebrate, templates, logs, seeds }) {
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [tasks, setTasks] = useState([]);
  const [mood, setMood] = useState("");
  const [isLazy, setIsLazy] = useState(false);
  const [lastSaved, setLastSaved] = useState(null);
  const [isSyncing, setIsSyncing] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [newTask, setNewTask] = useState({ label: "", category: "side", recurrence: "daily" });

  const identityStats = useMemo(() => {
    const s = { side: 0, lang: 0, health: 0, fruits: 0, streak: 0 };
    const defaultMap = { 't-side': 'side', 't-lang': 'lang', 't-health': 'health' };
    logs.forEach(l => {
      const checkedInLog = l.tasks?.filter(t => t.checked) || [];
      const hasSide = checkedInLog.some(t => defaultMap[t.id] === 'side' || templates.find(temp => temp.id === t.id)?.category === 'side');
      const hasLang = checkedInLog.some(t => defaultMap[t.id] === 'lang' || templates.find(temp => temp.id === t.id)?.category === 'lang');
      const hasHealth = checkedInLog.some(t => defaultMap[t.id] === 'health' || templates.find(temp => temp.id === t.id)?.category === 'health');
      if (hasSide && hasLang && hasHealth) s.fruits++;
      checkedInLog.forEach(task => {
        let cat = defaultMap[task.id] || templates.find(temp => temp.id === task.id)?.category;
        if (cat && s[cat] !== undefined) s[cat]++;
      });
    });
    const todayStr = new Date().toISOString().split('T')[0];
    let checkDate = new Date(todayStr);
    let currentStreak = 0;
    for (let i = 0; i < 365; i++) {
      const dStr = checkDate.toISOString().split('T')[0];
      const log = logs.find(l => l.date === dStr);
      if (log?.tasks?.some(t => t.checked)) { currentStreak++; checkDate.setDate(checkDate.getDate() - 1); } 
      else if (dStr === todayStr) { checkDate.setDate(checkDate.getDate() - 1); }
      else break;
    }
    s.streak = currentStreak;
    return s;
  }, [logs, templates]);

  // ç¨±è™Ÿç³»çµ±
  const getIdentityTitle = (cat, count) => {
    if (count >= 100) return "å¤§å¸«";
    if (count >= 50) return "å¯¦è¸å®¶";
    if (count >= 20) return "è¦ºé†’è€…";
    return "åˆè¡Œè€…";
  };

  const dailyAffirmation = useMemo(() => {
    if (seeds.length === 0) return "ä»Šå¤©ä¸éœ€è¦å®Œç¾ï¼Œåªè¦æ²’æœ‰æ”¾æ£„ã€‚";
    const randomSeed = seeds[Math.floor(Math.random() * seeds.length)];
    return randomSeed.contract.split('ã€‚')[0] + 'ã€‚';
  }, [seeds, selectedDate]);

  const fetchDateData = useCallback(async (dateStr) => {
    if (!user) return;
    const path = getPath('dailyLogs');
    if (!path) return;
    const docRef = doc(db, path, dateStr);
    const docSnap = await getDoc(docRef);
    const targetDate = new Date(dateStr);
    const dayOfWeek = targetDate.getDay();
    const dayOfMonth = targetDate.getDate();
    const defaultTemplates = [
      { id: 't-side', label: 'å‰¯æ¥­ï½œè´–å›è‡ªç”±æ™‚é–“', sub: 'æ‰“é–‹æ–‡ä»¶/æ”¹ä¸€è¡Œ/éŒ„å€‹é»å­', category: 'side', recurrence: 'daily' },
      { id: 't-lang', label: 'èªè¨€ï½œ10åˆ†é˜å¤–äº¤å®˜', sub: 'çœ‹å½±ç‰‡/è½éŸ³æª”/èƒŒä¸€è©', category: 'lang', recurrence: 'daily' },
      { id: 't-health', label: 'å¥åº·ï½œä¸å†æƒ¡åŒ–çš„é¸æ“‡', sub: 'å°‘ç³–/å¤šèµ°/æ—©ç¡', category: 'health', recurrence: 'daily' }
    ];
    const allTemplates = [...defaultTemplates, ...templates];
    const filtered = allTemplates.filter(t => {
      if (t.recurrence === 'daily') return true;
      if (t.recurrence === 'once' && t.targetDate === dateStr) return true;
      if (t.recurrence === 'weekly' && (t.dayOfWeek === dayOfWeek || !t.dayOfWeek)) return true;
      if (t.recurrence === 'monthly' && t.dayOfMonth === dayOfMonth) return true;
      return false;
    });
    if (docSnap.exists()) {
      const d = docSnap.data();
      setTasks(filtered.map(temp => ({ ...temp, checked: d.tasks?.find(st => st.id === temp.id)?.checked || false })));
      setMood(d.mood || ""); setIsLazy(d.isLazy || false);
      if(d.updatedAt) setLastSaved(new Date(d.updatedAt.seconds * 1000).toLocaleTimeString());
    } else {
      setTasks(filtered.map(t => ({ ...t, checked: false })));
      setMood(""); setIsLazy(false); setLastSaved(null);
    }
  }, [db, getPath, templates, user]);

  useEffect(() => { fetchDateData(selectedDate); }, [selectedDate, fetchDateData]);

  const sync = async (updatedTasks, updatedMood, updatedLazy) => {
    const path = getPath('dailyLogs');
    if (!path) return;
    setIsSyncing(true);
    await setDoc(doc(db, path, selectedDate), {
      date: selectedDate,
      tasks: updatedTasks.map(({id, checked}) => ({id, checked})),
      mood: updatedMood,
      isLazy: updatedLazy,
      updatedAt: serverTimestamp()
    });
    setLastSaved(new Date().toLocaleTimeString());
    setIsSyncing(false);
  };

  const toggleTask = (id) => {
    if (isLazy) return;
    const updated = tasks.map(t => t.id === id ? { ...t, checked: !t.checked } : t);
    setTasks(updated);
    const defaultMap = { 't-side': 'side', 't-lang': 'lang', 't-health': 'health' };
    const checkCat = (cat) => updated.some(t => t.checked && (defaultMap[t.id] === cat || t.category === cat));
    if (checkCat('side') && checkCat('lang') && checkCat('health') && selectedDate === new Date().toISOString().split('T')[0]) {
       const wasC = tasks.some(t => t.checked && (defaultMap[t.id] === 'side' || t.category === 'side')) && 
                    tasks.some(t => t.checked && (defaultMap[t.id] === 'lang' || t.category === 'lang')) && 
                    tasks.some(t => t.checked && (defaultMap[t.id] === 'health' || t.category === 'health'));
       if (!wasC) onCelebrate();
    }
    sync(updated, mood, isLazy);
  };

  return (
    <div className="space-y-8 animate-in fade-in duration-500">
      <Card style={{ backgroundColor: theme.primary }} className="border-none text-white overflow-hidden relative p-8 shadow-2xl">
         <div className="absolute top-0 right-0 p-8 opacity-10"><Trophy size={140} /></div>
         <div className="relative z-10">
            <div className="flex justify-between items-start mb-2">
               <p className="text-[10px] font-black uppercase tracking-[0.4em] text-white/40">Manifestation Archive</p>
               <div className="flex items-center gap-1.5 bg-amber-500 text-white px-3 py-1 rounded-full text-[9px] font-black animate-pulse shadow-lg shadow-amber-500/20">
                  <Flame size={10} fill="white" /> {identityStats.streak} DAYS STREAK
               </div>
            </div>
            <h3 className="text-4xl font-black text-white">{identityStats.fruits} <span className="text-xs text-white/50 font-bold uppercase tracking-widest ml-1">Fruits</span></h3>
            <div className="grid grid-cols-3 gap-3 mt-8">
               <StatItem label="å‰¯æ¥­" count={identityStats.side} title={getIdentityTitle('side', identityStats.side)} color="#cb914a" />
               <StatItem label="èªè¨€" count={identityStats.lang} title={getIdentityTitle('lang', identityStats.lang)} color="#86a0bb" />
               <StatItem label="å¥åº·" count={identityStats.health} title={getIdentityTitle('health', identityStats.health)} color="#5b8e7d" />
            </div>
         </div>
      </Card>

      <div className="text-center px-4">
         <p className="text-xs font-medium italic opacity-40 leading-relaxed">ã€Œ{dailyAffirmation}ã€</p>
      </div>

      <header className="flex justify-between items-center px-2">
        <div className="relative group">
           <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="bg-white/70 backdrop-blur-md border border-slate-200 rounded-2xl px-5 py-2.5 text-xs font-black outline-none shadow-sm transition-all focus:ring-2 focus:ring-amber-200" />
           {isSyncing && <div className="absolute -top-1 -right-1 w-2 h-2 bg-amber-600 rounded-full animate-ping"></div>}
        </div>
        <div className="flex gap-2">
          <button onClick={() => setIsEditing(!isEditing)} className={`p-2.5 rounded-2xl transition-all ${isEditing ? 'bg-amber-100 text-amber-700 shadow-inner' : 'bg-white text-slate-400 shadow-sm hover:bg-slate-50'}`}>
            <Settings2 size={20} />
          </button>
          <button onClick={() => { const l = !isLazy; setIsLazy(l); sync(tasks, mood, l); }} className={`px-5 py-2.5 rounded-2xl text-[10px] font-black transition-all border ${isLazy ? 'bg-slate-800 text-white border-slate-800 shadow-lg' : 'bg-white text-slate-400 border-slate-200 shadow-sm'}`}>
            {isLazy ? 'ğŸŒ™ ç§‹çœ ' : 'â˜• ä¼‘æ¯'}
          </button>
        </div>
      </header>

      {isEditing && (
        <Card className="bg-[#fdfbf7] border-dashed border-2 space-y-6 animate-in slide-in-from-top-4 border-amber-200/50">
          <div className="flex items-center gap-2 text-amber-800 font-black"><Settings2 size={16}/><span className="text-xs uppercase tracking-widest">ä»»å‹™æ¶æ§‹èª¿æ•´</span></div>
          <div className="flex flex-col gap-5">
             <input value={newTask.label} onChange={e => setNewTask({...newTask, label: e.target.value})} placeholder="ä»»å‹™æ¨™é¡Œ..." className="w-full bg-white border-none rounded-2xl px-6 py-4 text-sm font-bold shadow-sm" />
             <div className="space-y-3">
                <p className="text-[9px] font-black opacity-30 uppercase ml-2">æ­¸å±¬é¡åˆ¥</p>
                <div className="flex flex-wrap gap-2">
                   {[['side', 'å‰¯æ¥­'], ['lang', 'èªè¨€'], ['health', 'å¥åº·'], ['other', 'é›œé …']].map(([id, name]) => (
                     <button key={id} onClick={() => setNewTask({...newTask, category: id})} className={`px-4 py-2.5 rounded-xl text-[10px] font-black border transition-all ${newTask.category === id ? 'bg-[#14233a] text-white border-[#14233a]' : 'bg-white text-slate-400 border-slate-200'}`}>{name}</button>
                   ))}
                </div>
             </div>
             <div className="space-y-3">
                <p className="text-[9px] font-black opacity-30 uppercase ml-2">å¾ªç’°æ©Ÿåˆ¶</p>
                <div className="flex gap-2">
                   {['daily', 'weekly', 'once'].map(r => (
                     <button key={r} onClick={() => setNewTask({...newTask, recurrence: r})} className={`flex-1 py-2.5 rounded-xl text-[9px] font-black border transition-all ${newTask.recurrence === r ? 'bg-amber-600 text-white border-amber-600' : 'bg-white text-slate-400 border-slate-200'}`}>{r === 'daily' ? 'æ¯å¤©' : r === 'weekly' ? 'æ¯é€±' : 'å–®æ¬¡'}</button>
                   ))}
                </div>
             </div>
             <Button onClick={async () => {
                if(!newTask.label) return;
                const path = getPath('taskTemplates');
                if(!path) return;
                await addDoc(collection(db, path), { ...newTask, targetDate: selectedDate, dayOfWeek: new Date(selectedDate).getDay(), createdAt: serverTimestamp() });
                setNewTask({ label: "", category: "side", recurrence: "daily" });
             }} variant="primary" className="w-full py-4">éƒ¨ç½²è‡³ç”Ÿå‘½ç³»çµ±</Button>
          </div>
        </Card>
      )}

      <div className={`space-y-8 transition-all duration-700 ${isLazy ? 'opacity-30 blur-[6px] pointer-events-none scale-95 grayscale' : ''}`}>
        {[['side', 'å‰¯æ¥­ç™¼å±•', theme.accent], ['lang', 'èªè¨€å­¸ç¿’', theme.secondary], ['health', 'èº«é«”å¥åº·', theme.success], ['other', 'ç”Ÿæ´»é›œé …', theme.border]].map(([id, name, color]) => {
          const catTasks = tasks.filter(t => t.category === id);
          if (catTasks.length === 0 && !isEditing) return null;
          return (
            <div key={id} className="space-y-4">
               <h4 className="text-[11px] font-black uppercase tracking-[0.2em] opacity-30 px-4 flex items-center gap-3"><div className="w-2 h-2 rounded-full" style={{backgroundColor: color }}></div>{name}</h4>
               <div className="space-y-3">
                 {catTasks.map(t => (
                   <div key={t.id} className="flex items-center gap-3 group">
                     <div onClick={() => !isEditing && toggleTask(t.id)} className={`flex-1 flex items-start gap-5 p-7 rounded-[2.8rem] border transition-all ${t.checked ? 'bg-slate-100 border-transparent opacity-40 scale-[0.97]' : 'bg-white shadow-sm hover:translate-y-[-2px] hover:shadow-lg hover:border-amber-200'}`} style={{ borderColor: theme.border }}>
                        <div className={`w-8 h-8 mt-0.5 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all ${t.checked ? 'bg-[#14233a] border-[#14233a] rotate-[360deg]' : 'border-slate-300'}`}><CheckCircle2 size={18} className="text-white" /></div>
                        <div className="flex-1">
                           <div className="flex justify-between items-start">
                              <p className="text-base font-black leading-tight text-slate-800">{t.label}</p>
                              <span className="text-[8px] font-black uppercase bg-slate-50 border border-slate-100 px-2 py-0.5 rounded-md text-slate-400 tracking-widest">{t.recurrence || 'DAILY'}</span>
                           </div>
                           <p className="text-[10px] font-bold opacity-30 mt-2 uppercase tracking-widest flex items-center gap-1">{t.recurrence !== 'once' && <Repeat size={10} className="text-amber-600"/>} {t.sub || 'æ ¸å¿ƒè¡Œç‚ºæŒ‡æ¨™'}</p>
                        </div>
                     </div>
                     {isEditing && t.id.length > 10 && (
                       <button onClick={async () => { const p = getPath('taskTemplates'); if(p) await deleteDoc(doc(db, p, t.id)); }} className="p-4 text-rose-400 hover:bg-rose-50 rounded-full transition-colors"><Trash2 size={22} /></button>
                     )}
                   </div>
                 ))}
               </div>
            </div>
          );
        })}
      </div>

      <div className="space-y-4 pb-12">
        <label className="text-[10px] font-black uppercase tracking-widest opacity-30 ml-6 flex justify-between">æ­¤åˆ»éˆé­‚ç‹€æ…‹ {lastSaved && <span className="text-emerald-600">å·²å­˜å…¥ç”Ÿå‘½æª”æ¡ˆ {lastSaved}</span>}</label>
        <textarea value={mood} onChange={e => setMood(e.target.value)} onBlur={() => sync(tasks, mood, isLazy)} className="w-full h-40 bg-white border border-slate-100 rounded-[2.5rem] p-8 text-sm outline-none focus:ring-4 focus:ring-amber-50 shadow-inner leading-relaxed" placeholder="èª å¯¦åœ°è¨˜éŒ„ä¸‹æ­¤åˆ»..." />
      </div>
    </div>
  );
}

function StatItem({ label, count, title, color }) {
  return (
    <div className="bg-white/5 rounded-2xl p-3 flex flex-col gap-1 border border-white/5 backdrop-blur-md">
       <span className="text-[9px] font-black uppercase opacity-40">{label} {title}</span>
       <span className="text-lg font-black" style={{ color }}>{count}</span>
    </div>
  );
}

// --- ç•™è¨€æ¿ ---
function ReflectView({ db, user, getPath, journals, logs }) {
  const [msg, setMsg] = useState("");
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [saving, setSaving] = useState(false);
  const save = async () => {
    if (!user || !msg.trim()) return;
    const path = getPath('journalEntries');
    if (!path) return;
    setSaving(true);
    try {
      await addDoc(collection(db, path), { date: selectedDate, message: msg, createdAt: serverTimestamp() });
      setMsg("");
    } finally { setSaving(false); }
  };
  const combined = useMemo(() => {
    const list = [...journals.map(j => ({ ...j, type: 'journal' })), ...logs.filter(l => l.mood).map(l => ({ id: `m-${l.date}`, date: l.date, mood: l.mood, type: 'mood' }))];
    return list.sort((a,b) => b.date.localeCompare(a.date));
  }, [journals, logs]);
  return (
    <div className="space-y-10 animate-in fade-in">
      <Card className="space-y-6 bg-amber-50/20 border-amber-100/50 shadow-xl shadow-amber-900/5">
        <div className="flex items-center gap-2 text-amber-800"><StickyNote size={18} /><h2 className="text-xl font-black tracking-tighter">èˆ‡æœªä¾†çš„å°è©±</h2></div>
        <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="w-full bg-white border-none rounded-2xl p-4 text-xs font-black outline-none shadow-sm" />
        <textarea value={msg} onChange={e => setMsg(e.target.value)} className="w-full h-40 bg-white border-none rounded-[2rem] p-7 text-sm leading-relaxed outline-none shadow-inner" placeholder="é€™æ®µè©±ï¼Œç•™çµ¦ 2026 å¹´åº•çš„ä½ çœ‹..." />
        <Button onClick={save} loading={saving} variant="accent" className="w-full text-xs font-black py-5 shadow-lg shadow-amber-200/50">å°å­˜æ™‚å…‰ç•™è¨€</Button>
      </Card>
      <div className="space-y-6">
        {combined.slice(0, 15).map(i => (
          <div key={i.id} className="relative bg-white p-8 rounded-[2.5rem] border-[0.5px] border-slate-100 shadow-sm hover:border-amber-200 transition-all group">
            <span className="text-[10px] font-black opacity-20 uppercase tracking-widest block mb-4">{i.date} {i.type === 'mood' ? 'ãƒ» å¿ƒå¢ƒå¿«ç…§' : 'ãƒ» æ™‚å…‰ä¿¡ä»¶'}</span>
            <p className="text-base font-medium leading-relaxed text-slate-600">{i.message || i.mood}</p>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- æˆé•·æ›²ç·šé é¢ ---
function AIView({ logs, journals, db, getPath, seeds }) {
  const [res, setRes] = useState("");
  const [loading, setLoading] = useState(false);
  const [wish, setWish] = useState("");
  const [wishCategory, setWishCategory] = useState("side");
  const heatMapData = useMemo(() => {
    const days = {};
    logs.forEach(l => {
      const score = (l.tasks?.filter(t => t.checked).length || 0) + (l.mood ? 1 : 0);
      days[l.date] = score;
    });
    return days;
  }, [logs]);
  return (
    <div className="space-y-12 animate-in fade-in pb-32">
      <section className="space-y-6">
        <div className="flex justify-between items-end px-1">
           <div><h3 className="text-2xl font-black tracking-tighter">2026 æˆé•·æ›²ç·š</h3><p className="text-[10px] opacity-40 font-bold mt-1 uppercase tracking-[0.2em]">æ¯ä¸€é»äº®èµ·éƒ½æ˜¯ä¸€æ¬¡è¦ºé†’</p></div>
           <Wind size={24} className="text-slate-300 animate-pulse" />
        </div>
        <Card className="overflow-x-auto p-8 bg-white/50 backdrop-blur-md">
           <div className="flex gap-1.5 min-w-[650px]">
              {Array.from({ length: 52 }).map((_, weekIndex) => (
                <div key={weekIndex} className="flex flex-col gap-1.5">
                  {Array.from({ length: 7 }).map((_, dayIndex) => {
                    const d = new Date(2026, 0, 1 + (weekIndex * 7 + dayIndex));
                    const dStr = d.toISOString().split('T')[0];
                    const isToday = dStr === new Date().toISOString().split('T')[0];
                    const score = heatMapData[dStr] || 0;
                    const opacity = score === 0 ? 0.08 : score <= 2 ? 0.35 : score <= 4 ? 0.65 : 1;
                    return (
                      <div key={dayIndex} className={`w-4 h-4 rounded-[4px] transition-all hover:scale-150 hover:bg-amber-500 shadow-sm ${isToday ? 'ring-2 ring-amber-500 ring-offset-2 animate-pulse' : ''}`} style={{ backgroundColor: theme.primary, opacity }} title={`${dStr}: ${score} pt`}></div>
                    );
                  })}
                </div>
              ))}
           </div>
        </Card>
      </section>

      <section className="space-y-6">
        <div className="flex justify-between items-center px-2">
           <h3 className="text-xl font-black tracking-tighter flex items-center gap-2"><Flame size={22} className="text-orange-500" /> é¡¯åŒ–å¥‘ç´„ç‰†</h3>
           <button onClick={async () => {
              setLoading(true);
              const r = await callGemini("æˆ‘æ±ºå®šæ”¾ä¸‹éå»ï¼Œå¾æ­¤åˆ»é‡å•Ÿã€‚è«‹çµ¦æˆ‘ä¸€æ®µé¿é¢¨æ¸¯å¼çš„éˆé­‚è‚¯å®šç•™è¨€ã€‚");
              setRes(r); setLoading(false);
           }} className="flex items-center gap-1.5 px-4 py-1.5 bg-[#14233a] text-white rounded-full text-[9px] font-black active:scale-95 transition-all shadow-lg hover:bg-slate-800"><RefreshCw size={10} className={loading ? "animate-spin" : ""} /> é‡å•Ÿéˆé­‚ç¯€å¥</button>
        </div>
        <Card className="space-y-6 bg-[#fdfbf7] border-none shadow-xl">
           <div className="flex flex-col gap-4">
              <input value={wish} onChange={e => setWish(e.target.value)} placeholder="éˆé­‚æ·±è™•çš„ 2026 é¡˜æœ›..." className="w-full bg-white border-none rounded-2xl px-7 py-5 text-sm font-bold shadow-inner" />
              <div className="flex gap-3">
                 {[['side', 'å‰¯æ¥­'], ['lang', 'èªè¨€'], ['health', 'å¥åº·']].map(([id, name]) => (
                   <button key={id} onClick={() => setWishCategory(id)} className={`flex-1 py-3 rounded-xl text-[10px] font-black border transition-all ${wishCategory === id ? 'bg-[#14233a] text-white shadow-lg' : 'bg-white text-slate-300'}`}>{name}</button>
                 ))}
                 <Button onClick={async () => {
                    if(!wish) return;
                    setLoading(true);
                    const r = await callGemini(`éˆé­‚é¡˜æœ›ï¼š${wish}ã€‚é¡åˆ¥ï¼š${wishCategory}ã€‚è«‹ç”Ÿæˆä¸€æ®µæ¥µç°¡çš„èº«åˆ†èªåŒå¥‘ç´„ã€‚`);
                    const p = getPath('seeds');
                    if(p) await addDoc(collection(db, p), { title: wish, category: wishCategory, contract: r, createdAt: serverTimestamp() });
                    setWish(""); setRes(r); setLoading(false);
                 }} loading={loading} variant="accent" className="px-10">ç«‹ç´„</Button>
              </div>
           </div>
        </Card>
        <div className="grid grid-cols-1 gap-6">
          {seeds.map(s => (
            <Card key={s.id} className="relative border-none bg-white shadow-2xl p-10 group overflow-hidden transition-all hover:scale-[1.01]">
               <div className="relative z-10">
                  <div className="flex justify-between items-start mb-6">
                     <span className="text-[10px] font-black uppercase text-[#cb914a] tracking-widest bg-amber-50 px-4 py-1.5 rounded-full">{s.category} CONTRACT</span>
                     <button onClick={async () => { const p = getPath('seeds'); if(p) await deleteDoc(doc(db, p, s.id)); }} className="text-slate-200 hover:text-rose-400"><Trash2 size={18} /></button>
                  </div>
                  <p className="text-2xl font-black mb-4 tracking-tighter text-slate-800">{s.title}</p>
                  <p className="text-sm leading-relaxed opacity-70 italic font-medium border-l-4 border-amber-200 pl-6 text-slate-600">{s.contract}</p>
               </div>
            </Card>
          ))}
        </div>
      </section>
      {res && <Card className="animate-in slide-in-from-bottom-6 border-indigo-200 p-8 shadow-xl"><p className="text-base font-black italic text-indigo-900 text-center">ã€Œ{res}ã€</p></Card>}
    </div>
  );
}

function FavoritesView({ favorites, db, getPath }) {
  return (
    <div className="space-y-10 animate-in fade-in pb-32">
      <header className="flex justify-between items-center px-4">
        <h2 className="text-3xl font-black tracking-tighter">éˆé­‚æ”¶è—åº«</h2>
        <div className="w-14 h-14 rounded-full bg-indigo-50 flex items-center justify-center shadow-inner"><Bookmark size={28} className="text-indigo-600" /></div>
      </header>
      {favorites.length === 0 ? (
        <div className="py-32 text-center flex flex-col items-center gap-8 opacity-10"><Sparkles size={100} /><p className="text-sm font-black uppercase tracking-[0.5em]">No Insights Stored</p></div>
      ) : (
        <div className="space-y-8">
          {favorites.map(f => (
            <Card key={f.id} className="relative bg-white shadow-2xl border-none p-12 group transition-all">
              <div className="flex justify-between items-start mb-8">
                <span className="text-[10px] font-black bg-[#14233a] text-white px-5 py-2 rounded-full uppercase tracking-widest">{f.range}</span>
                <button onClick={async () => { const p = getPath('favoriteReviews'); if(p) await deleteDoc(doc(db, p, f.id)); }} className="text-slate-200 group-hover:text-rose-400 transition-colors"><Trash2 size={20} /></button>
              </div>
              <p className="text-xl leading-relaxed text-slate-700 font-bold">{f.content}</p>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}